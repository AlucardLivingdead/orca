#!@PYTHON@
#
# Orca
#
# Copyright 2004-2006 Sun Microsystems Inc.
#
# This library is free software; you can redistribute it and/or
# modify it under the terms of the GNU Library General Public
# License as published by the Free Software Foundation; either
# version 2 of the License, or (at your option) any later version.
#
# This library is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
# Library General Public License for more details.
#
# You should have received a copy of the GNU Library General Public
# License along with this library; if not, write to the
# Free Software Foundation, Inc., 59 Temple Place - Suite 330,
# Boston, MA 02111-1307, USA.

"""Permits the user to set up preferences for orca using speech prompts
and a command line interface.
"""

import os, commands, sys, time
import pprint

import orca.acss
import orca.settings

from orca.orca_i18n import _  # for gettext support

trueStr  = " = True\n"
falseStr = " = False\n"

# Create the user's .orca directory if it doesn't already exist.
#
orcadir = os.path.join(os.environ["HOME"], ".orca")
try:
    os.chdir(orcadir)
except:
    print _("Creating .orca directory.")
    try:
        os.mkdir(orcadir)
    except:
        # [[[TODO: WDW - need to print a message and fail here.]]]
        #
        pass

# Create the user's .orca/orca-scripts directory if it doesn't 
# already exist.
#
orcaScriptDir = os.path.join(os.environ["HOME"], ".orca", "orca-scripts")
try:
    os.chdir(orcaScriptDir)
except:
    print _("Creating .orca script directory.")
    try:
        os.mkdir(orcaScriptDir)
    except:
        # [[[TODO: richb - need to print a message and fail here.]]]
        #
        pass

# Create an empty __init__.py file in the user's script directory, if
# it doesn't already exist.
#
initFile = os.path.join(os.environ["HOME"], ".orca", \
                        "orca-scripts", "__init__.py")
if not os.path.exists(initFile):
    print _("Creating __init_.py in .orca script directory.")
#    try:
    print "initFile: ", initFile
    os.close(os.open(initFile, os.O_CREAT, 0700))
#    except:
#        # [[[TODO: richb - need to print a message and fail here.]]]
#        #
#        pass

        
# Create a new settings file
#
settingsFileName = os.path.join(orcadir, "user-settings.py")
settings = open(settingsFileName, "w")
settings.writelines("# user-settings.py - custom Orca settings\n")
settings.writelines("# Generated by orca-setup.  DO NOT EDIT THIS FILE!!!\n")
settings.writelines("# If you want permanent customizations that will not\n")
settings.writelines("# be overwritten, edit orca-customizations.py.\n")
settings.writelines("#\n")
settings.writelines("import re\n")
settings.writelines("\n")
settings.writelines("import orca.debug\n")
settings.writelines("import orca.settings\n")
settings.writelines("import orca.acss\n")
settings.writelines("\n")
settings.writelines("#orca.debug.debugLevel = orca.debug.LEVEL_OFF\n")
settings.writelines("orca.debug.debugLevel = orca.debug.LEVEL_SEVERE\n")
settings.writelines("#orca.debug.debugLevel = orca.debug.LEVEL_WARNING\n")
settings.writelines("#orca.debug.debugLevel = orca.debug.LEVEL_INFO\n")
settings.writelines("#orca.debug.debugLevel = orca.debug.LEVEL_CONFIGURATION\n")
settings.writelines("#orca.debug.debugLevel = orca.debug.LEVEL_FINE\n")
settings.writelines("#orca.debug.debugLevel = orca.debug.LEVEL_FINER\n")
settings.writelines("#orca.debug.debugLevel = orca.debug.LEVEL_FINEST\n")
settings.writelines("#orca.debug.debugLevel = orca.debug.LEVEL_ALL\n")
settings.writelines("\n")
settings.writelines("#orca.debug.eventDebugLevel = orca.debug.LEVEL_OFF\n")
settings.writelines("#orca.debug.eventDebugFilter =  None\n")
settings.writelines("#orca.debug.eventDebugFilter = re.compile('[\S]*focus|[\S]*activ')\n")
settings.writelines("#orca.debug.eventDebugFilter = re.compile('nomatch')\n")
settings.writelines("#orca.debug.eventDebugFilter = re.compile('[\S]*:accessible-name')\n")

settings.writelines("\n")
settings.writelines("#orca.debug.debugFile = open('debug.out', 'w', 0)\n")
settings.writelines("\n")

# Speech setup
#
import orca.speech as speech
import orca.speechserver as speechserver

servers = []

def sayAndPrint(text, stop=False, getInput=False):
    """Prints the given text.  In addition, if the text field
    is not None, speaks the given text, optionally interrupting
    anything currently being spoken.
    
    Arguments:
    - text: the text to print and speak
    - stop: if True, interrupt any speech currently being spoken
    - getInput: if True, elicits raw input from the user and returns it

    Returns raw input from the user if getInput is True.
    """
    
    if stop:
	speech.stop()

    speech.speak(text)

    if getInput:
        return raw_input(text)
    else:
        print text        

def setupSpeech():
    """Sets up speech support.  If speech setup is successful and the
    user wants it, writes speech settings to the setting file and returns
    True.  If speech is not available, or the user doesn't want speech,
    returns False.
    """
    
    global servers

    # Use this because callbacks will often hang when not running
    # with bonobo main in use.
    #
    orca.settings.enableSpeechCallbacks = False

    factories = speech.getSpeechServerFactories()
    if len(factories) == 0:
        print _("Speech is unavailable.")
        return False

    speech.init()
    speech.speak(_("Welcome to Orca setup."))

    workingFactories = []
    for factory in factories:
        try:
	    infos = factory.SpeechServer.getSpeechServerInfos()
	    workingFactories.append([factory, infos])
	except:
	    pass

    if len(workingFactories) == 0:
        print _("Speech is unavailable.")
        return False
    elif len(workingFactories) > 1:    
        speech.speak(_("Select desired speech system."))
	choices = {}
	i = 1
        for workingFactory in workingFactories:
	    choices[i] = workingFactory
	    sayAndPrint(_("%d. %s") 
		        % (i, workingFactory[0].SpeechServer.getFactoryName()))
	    i += 1
	choice = int(sayAndPrint(_("Enter choice: "), False, True))
        if (choice <= 0) or (choice >= i):	
            sayAndPrint(_("Speech will not be used.\n"))
            return False
	[factory, infos] = choices[choice]
    else:
	[factory, infos] = workingFactories[0]

    for info in infos:
        try:
	    server = factory.SpeechServer.getSpeechServer(info)
	    if server:
	        servers.append(server)
        except:
            pass

    if len(servers) == 0:
        sayAndPrint(_("No servers available.\n"))
        sayAndPrint(_("Speech will not be used.\n"))
        return False
    if len(servers) > 1:
        speech.speak(_("Select desired speech server."))
	i = 1
	choices = {}
        for server in servers:
	    sayAndPrint(_("%d. %s") % (i, server.getInfo()[0]))
	    choices[i] = server
	    i += 1
	choice = int(sayAndPrint(_("Enter choice: "), False, True))
        if (choice <= 0) or (choice >= i):	
            sayAndPrint(_("Speech will not be used.\n"))
            return False
	server = choices[choice]
    else:
	server = servers[0]

    families = server.getVoiceFamilies()
    if len(families) == 0:
        sayAndPrint(_("No voices available.\n"))
        sayAndPrint(_("Speech will not be used.\n"))
        return False
    if len(families) > 1:
        speech.speak(_("Select desired voice."))
	i = 1
	choices = {}
        for family in families:
            name = family[speechserver.VoiceFamily.NAME]
            acss = orca.acss.ACSS({orca.acss.ACSS.FAMILY : family})
            sayAndPrint(_("%d. %s") % (i, name))
	    choices[i] = acss
	    i += 1
	choice = int(sayAndPrint(_("Enter choice: "), False, True))
        if (choice <= 0) or (choice >= i):	
            sayAndPrint(_("Speech will not be used.\n"))
            return False
	defaultACSS = choices[choice]
    else:
        defaultACSS = orca.acss.ACSS({orca.acss.ACSS.FAMILY : families[0]})

    # Force the rate to 50 so it will be set to something
    # and output to the user settings file.  50 is chosen
    # here, BTW, since it is the default value.  The same
    # goes for gain (volume) and average-pitch, but they
    # range from 0-10 instead of 0-100.
    #
    defaultACSS[orca.acss.ACSS.RATE] = 50
    defaultACSS[orca.acss.ACSS.GAIN] = 5
    defaultACSS[orca.acss.ACSS.AVERAGE_PITCH] = 5
    uppercaseACSS = orca.acss.ACSS({orca.acss.ACSS.AVERAGE_PITCH : 6})
    hyperlinkACSS = orca.acss.ACSS({orca.acss.ACSS.AVERAGE_PITCH : 2})

    voices = {
	orca.settings.DEFAULT_VOICE   : defaultACSS,
	orca.settings.UPPERCASE_VOICE : uppercaseACSS,
	orca.settings.HYPERLINK_VOICE : hyperlinkACSS
    }

    settings.writelines("orca.settings.speechServerFactory = '" \
			+ factory.__name__ + "'\n")
    settings.writelines("orca.settings.speechServerInfo = " \
			+ repr(server.getInfo()) + "\n")

    settings.writelines("orca.settings.voices = {\n")
    for voice in voices:
	settings.writelines("     '%s' : orca.acss.ACSS(" % voice)
        settings.writelines(pprint.pformat(voices[voice]) + "),\n")
    settings.writelines("}\n\n")

    # Ask the user if they would like to enable echoing by word.
    #
    echoByWord = sayAndPrint(_("Enable echo by word?  Enter y or n: "), True, True)
    if echoByWord[0:1] == 'Y' or echoByWord[0:1] == 'y':
        state = trueStr
    else:
        state = falseStr
    settings.writelines("orca.settings.enableEchoByWord" + state)

    # Ask the user if they would like to enable key echo. If they say
    # yes, then for each of the five different types of keys, ask the 
    # user if they would like to enable them. 
    #
    # These key types are:
    #
    #   o Alphanumeric and punctuation keys
    #
    #   o Modifier keys: CTRL, ALT, Shift, Insert, and "Fn" on laptops.
    #
    #   o Locking keys: Caps Lock, Num Lock, Scroll Lock, etc.
    #
    #   o Function keys: The keys at the top of the keyboard.
    #
    #   o Action keys: space, enter, escape, tab, backspace, delete, arrow
    #     keys, page up, page down, etc.
    #
    keyEcho = sayAndPrint(_("Enable key echo?  Enter y or n: "), True, True)
    if keyEcho[0:1] == 'Y' or keyEcho[0:1] == 'y':
        settings.writelines("orca.settings.enableKeyEcho" + trueStr)

        echoPrintableKeys = sayAndPrint(_("Enable alphanumeric and punctuation keys?  Enter y or n: "), True, True)
        if echoPrintableKeys[0:1] == 'Y' or echoPrintableKeys[0:1] == 'y':
            state = trueStr
        else:
            state = falseStr
        settings.writelines("orca.settings.enablePrintableKeys" + state)

        echoModifierKeys = sayAndPrint(_("Enable modifier keys?  Enter y or n: "), True, True)
        if echoModifierKeys[0:1] == 'Y' or echoModifierKeys[0:1] == 'y':
            state = trueStr
        else:
            state = falseStr
        settings.writelines("orca.settings.enableModifierKeys" + state)

        echoLockingKeys = sayAndPrint(_("Enable locking keys?  Enter y or n: "), True, True)
        if echoLockingKeys[0:1] == 'Y' or echoLockingKeys[0:1] == 'y':
            state = trueStr
        else:
            state = falseStr
        settings.writelines("orca.settings.enableLockingKeys" + state)

        echoFunctionKeys = sayAndPrint(_("Enable function keys?  Enter y or n: "), True, True)
        if echoFunctionKeys[0:1] == 'Y' or echoFunctionKeys[0:1] == 'y':
            state = trueStr
        else:
            state = falseStr
        settings.writelines("orca.settings.enableFunctionKeys" + state)

        echoActionKeys = sayAndPrint(_("Enable action keys?  Enter y or n: "), True, True)
        if echoActionKeys[0:1] == 'Y' or echoActionKeys[0:1] == 'y':
            state = trueStr
        else:
            state = falseStr
        settings.writelines("orca.settings.enableActionKeys" + state)

    else:
        settings.writelines("orca.settings.enableKeyEcho" + falseStr)
        settings.writelines("orca.settings.enablePrintableKeys" + falseStr)
        settings.writelines("orca.settings.enableModifierKeys" + falseStr)
        settings.writelines("orca.settings.enableLockingKeys" + falseStr)
        settings.writelines("orca.settings.enableFunctionKeys" + falseStr)
        settings.writelines("orca.settings.enableActionKeys" + falseStr)

    return True

def setupBraille():
    """Sets up Braille support.  If Braille is available and the user
    wants it, returns True.  If Braille is unavailable or the user
    doesn't want it, returns False.
    """

    working = False
    try:
        import orca.braille as braille
        working = braille.init()
	braille.shutdown()
    except:
        pass

    if working:
        enableBraille = sayAndPrint(
            _("Braille support appears to work, enable it?  Enter y or n. "),
            False,
            True)

        if enableBraille[0:1] == 'Y' or enableBraille[0:1] == 'y':
            return True
        else:
            return False
    else:
        return False

def enableAccessibility():
    """Enables the GNOME accessibility flag.  Users need to log out and
    then back in for this to take effect."""

    alreadyEnabled = commands.getoutput(\
	"gconftool-2 --get /desktop/gnome/interface/accessibility")
    if alreadyEnabled != "true":
        os.system("gconftool-2 --type bool --set " \
		  + "/desktop/gnome/interface/accessibility true")

        sayAndPrint("Accessibility support for GNOME has been enabled.")
        sayAndPrint("You need to log out and log back in for the change "\
                    +"to take effect.")

enableSpeech = setupSpeech()
if enableSpeech == False:
    settings.writelines("orca.settings.enableEchoByWord" + falseStr)
    settings.writelines("orca.settings.enableKeyEcho" + falseStr)
    settings.writelines("\norca.settings.enableSpeech" + falseStr)
else:
    settings.writelines("\norca.settings.enableSpeech" + trueStr)

# We'll always enable braille for now.  Orca will recover gracefully
# if it cannot connect to BrlTTY.
#
settings.writelines("orca.settings.enableBraille" + trueStr)
    
#enableBraille = setupBraille()
#if enableBraille:
#    settings.writelines("orca.settings.enableBraille" + trueStr)
#else:
#    settings.writelines("orca.settings.enableBraille" + falseStr)

enableBrailleMonitor = sayAndPrint(_("Enable Braille Monitor?  Enter y or n: "), True, True)
if enableBrailleMonitor[0:1] == 'Y' or enableBrailleMonitor[0:1] == 'y':
    settings.writelines("orca.settings.enableBrailleMonitor" + trueStr)
else:
    settings.writelines("orca.settings.enableBrailleMonitor" + falseStr)

settings.writelines("\ntry:\n")
settings.writelines("    __import__(\"orca-customizations\")\n")
settings.writelines("except ImportError:\n")
settings.writelines("    pass\n")

enableAccessibility()

sayAndPrint("Orca setup finished.\n", True)
time.sleep(2)

for server in servers:
    server.shutdown()

speech.shutdown()
